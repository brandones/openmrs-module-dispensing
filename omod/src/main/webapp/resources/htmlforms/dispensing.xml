<htmlform formUuid="ba22eda5-148d-456e-8adc-f36247d1f7c3" formName="Dispensing" formEncounterType="8ff50dea-18a1-4609-b4c9-3f8f2d611b84" formVersion="1.0" class="dispensing-form">
    <script type="text/javascript">
        var $j = jQuery;

        htmlForm.getBeforeValidation().push(function() {
            var numErrors = 0;
            var numDispensed = 0;
            var scrolled = false;
            $('fieldset.medication').each(function() {
                var numEmptyFields = 0;
                var numFilledFields = 0;
                $(this).find('input:not(:last), select').each(function() {
                    $(this).removeClass('emptyValue');

                    if ($(this).val()) {
                        numFilledFields += 1;
                    } else {
                        numEmptyFields += 1;
                    }
                });
                if (numFilledFields > 0 &amp;&amp; numEmptyFields > 0) {
                    $(this).find('input:not(:last), select').each(function () {
                        if(!$(this).val()) {
                            if(!$(this).hasClass('illegalValue')) {
                                $(this).addClass('emptyValue');
                            }
                        } else {
                            if($(this).siblings('input[type="hidden"]').length > 0) {
                                if($(this).siblings('input[type="hidden"]').attr("value") == "") {
                                    $(this).addClass('emptyValue');
                                }
                            }
                        }
                    });
                    $(this).find('.field-error').first().html("All fields are required!").show();
                    numErrors += 1;
                    if(!scrolled) {
                        $(window).scrollTop($(this).offset().top);
                        scrolled = true;
                    }

                    $('.medication input.emptyValue, .medication select.emptyValue').on('blur', function() {
                        if ($(this).val()) {
                            if($(this).hasClass('illegalValue')) {
                                $(this).removeClass('emptyValue');
                            } else {
                                if($(this).siblings('input[type="hidden"]').length = 0) {
                                    $(this).removeClass('emptyValue').addClass('notEmpty');  
                                } else {
                                    if($(this).siblings('input[type="hidden"]').attr("value") != "") {
                                        $(this).removeClass('emptyValue').addClass('notEmpty');  
                                    }
                                }
                            }
                        } else {
                            $(this).removeClass('notEmpty').addClass('emptyValue');
                        }
                    });
                } else {
                    $(this).find('.field-error').first().html("").hide();
                    if (numFilledFields > 0) {
                        numDispensed += 1;
                    }
                }
            });
            if (numErrors == 0 &amp;&amp; numDispensed == 0) {
                $('fieldset.medication').first().find('.field-error').first().html("All fields are required!").show();
                $(window).scrollTop(300);
            }
            return numErrors == 0 &amp;&amp; numDispensed > 0;
        });
    </script>

    <h2>
        <uimessage code="mirebalais.dispensing.dispensing"/>
    </h2>
    <table id="who-where-when-view">
        <tr>
            <includeIf velocityTest="$user.hasRole('Application Role: sysAdmin')">
                <td>
                    <label><uimessage code="mirebalais.dispensing.dispensedBy"/></label>
                    <span><encounterProviderAndRole default="currentUser"
                                                    encounterRole="bad21515-fd04-4ff6-bfcd-78456d12f168" required="true"/></span>
                </td>
                <td>
                    <label><uimessage code="emr.location"/></label>
                    <span> <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/></span>
                </td>
                <td>
                    <label><uimessage code="emr.patientDashBoard.date"/></label>
                    <span><encounterDate id="encounterDate" default="today" /></span>
                </td>
            </includeIf>

            <includeIf velocityTest="($user.hasRole('Application Role: pharmacist') || $user.hasRole('Application Role: pharmacyAide')) and !$user.hasRole('Application Role: sysAdmin')">
                <div style="display:none">
                    <encounterProviderAndRole default="currentUser"
                                              encounterRole="bad21515-fd04-4ff6-bfcd-78456d12f168" providerRoles="8fd1552e-6cb9-4719-b198-23a2c512a073" required="true"/>
                    <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/>
                </div>

                <ifMode mode="ENTER">
                    <td>
                        <label><uimessage code="mirebalais.dispensing.dispensedBy"/></label>
                        <span><lookup expression="user.person.personName" /></span>
                    </td>
                    <td>
                        <label><uimessage code="emr.location"/></label>
                        <span><lookup complexExpression="$ui.format($sessionContext.sessionLocation)"/></span>
                    </td>
                </ifMode>

                <ifMode mode="VIEW" include="false">
                    <td>
                        <label><uimessage code="emr.patientDashBoard.date"/></label>
                        <span><encounterDate id="encounterDate" default="today" /></span>
                    </td>
                </ifMode>

            </includeIf>
        </tr>
    </table>
    <div id="typePrescription">
        <div>
            <span class="input-container">
                <label>
                    <uimessage code="dispensing.medication.typeOfPrescription"/>
                </label>
                <obs id="Timing of hospital prescription" required="true" class="select-arrow" conceptId="PIH:9292"/>
            </span>
            <span class="input-container">
                <label>
                    <uimessage code="dispensing.medication.locationOfPrescription"/>
                </label>

                <obs id="Discharge location" required="true" style="location" class="select-arrow" conceptId="PIH:9293" />
            </span>
        </div>
   </div>

    <repeat with="['1'],['2'],['3'],['4'],['5']">
        <obsgroup groupingConceptId="PIH:9070">
            <h3>
                <uimessage code="mirebalais.dispensing.medication"/>
                {0}
            </h3>
            <fieldset class="medication">
                <p class="field-error" style="display:none"></p>
                <p>
                    <label>
                        <uimessage code="mirebalais.dispensing.medicationName"/>
                    </label>
                    <obs id="name{0}" class="medication-name" conceptId="PIH:1282" answerDrugs="true"/>
                </p>
                <p class="inline">
                    <label>
                        <uimessage code="dispensing.medication.dose"/>
                    </label>
                    <obs id="dose{0}" class="doseInput" conceptId="CIEL:160856"/>
                    <obs id="doseUnit{0}" placeholder="Eg: mg" class="doseInput" conceptId="PIH:9074"/>
                </p>
                <p class="inline">
                    <label>
                        <uimessage code="mirebalais.dispensing.medicationFrequency"/>
                    </label>


                    <obs id="frequencyCoded{0}" class="select-arrow" conceptId="PIH:9363"
                         answerConceptIds=
                                 "PIH:OD,PIH:BID,PIH:TID,PIH:QID,PIH:5D,PIH:6D,PIH:7D,PIH:8D,PIH:9D,PIH:OM,PIH:ON,PIH:PRN,PIH:STAT,PIH:Q2H,PIH:Q3H,PIH:Q4H,PIH:Q6H,PIH:Q12H,PIH:CHLORO,PIH:5622"
                         answerLabels="OD,BID,TID,QID,5D,6D,7D,8D,9D,OM,ON,PRN,STAT,Q2H,Q3H,Q4H,Q6H,Q12H,CHLORO,OTHER" />
               </p>

                <p class="inline">
                    <label>
                        <uimessage code="mirebalais.dispensing.medicationDuration"  />
                    </label>
                    <obs id="duration{0}" class="doseInput" conceptId="CIEL:159368"/>
                        <obs id="durationUnit{0}" class="select-arrow" conceptId="PIH:6412"/>
                </p>
                <p class="inline">
                    <label>
                        <uimessage code="mirebalais.dispensing.medicationAmount"/>
                    </label>
                    <obs id="amount{0}" conceptId="PIH:9071"/>
                </p>
                <p>
                    <label>
                        <uimessage code="mirebalais.dispensing.medicationInstructions"/>
                    </label>
                    <obs id="instructions{0}" conceptId="PIH:9072"/>
                </p>
            </fieldset>
        </obsgroup>
    </repeat>

    <p class="prescriber">
        <label>
            <uimessage code="mirebalais.dispensing.prescriber"/>
        </label>
        <span class="select-arrow">
            <encounterProviderAndRole encounterRole="c458d78e-8374-4767-ad58-9f8fe276e01c"
                                      providerRoles="3182ee51-b895-4804-a342-5f261e995222,556ceee6-d899-43d4-a98b-7973ebc85b75"/>
        </span>
    </p>

    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <button class="submitButton confirm right" onclick="submitHtmlForm()"><uimessage code="mirebalais.save"/><i class="icon-spinner icon-spin icon-2x" style="display: none; margin-left: 10px;"></i></button>
            <button type="button" class="cancel">
                <uimessage code="emr.cancel"/>
            </button>
        </div>
    </ifMode>

</htmlform>